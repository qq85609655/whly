<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hailian.whly.reportstatistics.dao.ReportStatisticsDao">
    
	<sql id="reportStatisticsColumns">
		a.id AS "id",
		a.year AS "year",
		a.month AS "month",
		a.year_month AS "yearMonth",
		a.total_income AS "totalIncome",
		a.total_profit AS "totalProfit",
		a.total_tax AS "totalTax",
		a.emp_quantity AS "empQuantity",
		a.employee_compensation AS "employeeCompensation",
		a.loan_amount AS "loanAmount",
		a.order_quantity AS "orderQuantity",
		a.operating_costs AS "operatingCosts",
		a.status AS "status",
		a.company_id AS "companyId",
		a.company_name AS "companyName",
		a.area_id AS "area.id",
		a.area_name AS "areaName",
		a.type_id AS "typeId",
		a.type_name AS "typeName",
		a16.name AS "area.name"
	</sql>
	
	<sql id="reportStatisticsJoins">
		LEFT JOIN sys_area a16 ON a16.id = a.area_id
	</sql>
    <!--行业分析数据  -->
    <resultMap id="industryEnploymentNumberAnalysis" type="com.hailian.whly.reportstatistics.entity.ReportStatistics" >
    	<result column="type_name" property="typeName"/>
    	<result column="emp_quantity" property="empQuantity"/>
    </resultMap>
    <!--地区分析数据  -->
    <resultMap id="areaEnploymentNumberAnalysis" type="com.hailian.whly.reportstatistics.entity.ReportStatistics" >
    	<result column="area_name" property="areaName"/>
    	<result column="emp_quantity" property="empQuantity"/>
    </resultMap>
    
	<select id="get" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
		SELECT 
			<include refid="reportStatisticsColumns"/>
		FROM statis_view a
		<include refid="reportStatisticsJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<select id="findList" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
		SELECT 
			<include refid="reportStatisticsColumns"/>
		FROM statis_view a
		<include refid="reportStatisticsJoins"/>
		<where>
			
			<if test="id != null and id != ''">
				AND a.id = #{id}
			</if>
			<if test="year != null and year != ''">
				AND a.year = #{year}
			</if>
			<if test="month != null and month != ''">
				AND a.month = #{month}
			</if>
			<if test="yearMonth != null and yearMonth != ''">
				AND a.year_month = #{yearMonth}
			</if>
			<if test="status != null and status != ''">
				AND a.status = #{status}
			</if>
			<if test="companyId != null and companyId != ''">
				AND a.company_id = #{companyId}
			</if>
			<if test="companyName != null and companyName != ''">
				AND a.company_name LIKE 
					<if test="dbName == 'oracle'">'%'||#{companyName}||'%'</if>
					<if test="dbName == 'mssql'">'%'+#{companyName}+'%'</if>
					<if test="dbName == 'mysql'">concat('%',#{companyName},'%')</if>
			</if>
			<if test="area != null and area.id != null and area.id != ''">
				AND a.area_id = #{area.id}
			</if>
			<if test="areaName != null and areaName != ''">
				AND a.area_name = #{areaName}
			</if>
			<if test="typeId != null and typeId != ''">
				AND a.type_id = #{typeId}
			</if>
			<if test="typeName != null and typeName != ''">
				AND a.type_name = #{typeName}
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
		SELECT 
			<include refid="reportStatisticsColumns"/>
		FROM statis_view a
		<include refid="reportStatisticsJoins"/>
		<where>
			
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
			</otherwise>
		</choose>
	</select>
	
	
	<select id="getStaitic" parameterType="com.hailian.whly.reportstatistics.entity.ReportStatistics" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
		SELECT
			SUM(total_income) as "totalIncome",SUM(total_profit) as "totalProfit",SUM(total_tax) as "totalTax",SUM(emp_quantity) as "empQuantity",
			SUM(employee_compensation) as "employeeCompensation",SUM(loan_amount) as "loanAmount",SUM(order_quantity) as "orderQuantity",SUM(operating_costs) as "operatingCosts",
			month as "month", year as "year"
		FROM
			statis_view
		<where>
			<if test="typeId != null and typeId != ''">
				AND type_id = #{typeId}
			</if>
			<if test="areaName != null and areaName != ''">
				AND area_name = #{areaName}
			</if>
			<if test="companyId != null and companyId != ''">
				AND company_id = #{companyId}
			</if>
		</where> 
		
		GROUP BY
			year, month
	
	</select>
	
	
	<select id="getStaiticQytb" parameterType="com.hailian.whly.reportstatistics.entity.ReportStatistics" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
		SELECT
			<choose>  
	             <when test="statisticsType == 'MONTH'">p.`month` AS name,</when>  
	             <when test="statisticsType == 'areaName'">p.areaName AS name,</when> 
	             <when test="statisticsType == 'typeName'">p.typeName AS name,</when> 
          	</choose>
			FORMAT((ntotalIncome - IF(ptotalIncome,ptotalIncome,0)) / ntotalIncome * 100,2) AS totalIncome,
			FORMAT((ntotalProfit - IF(ptotalProfit,ptotalProfit,0)) / ntotalProfit * 100,2) AS totalProfit,
			FORMAT((ntotalTax - IF(ptotalTax,ptotalTax,0)) / ntotalTax * 100,2) AS totalTax,
			FORMAT((nempQuantity - IF(pempQuantity,pempQuantity,0)) / nempQuantity * 100,2) AS empQuantity,
			FORMAT((nemployeeCompensation - IF(pemployeeCompensation,pemployeeCompensation,0)) / nemployeeCompensation * 100,2) AS employeeCompensation,
			FORMAT((nloanAmount - IF(ploanAmount,ploanAmount,0)) / nloanAmount * 100,2) AS loanAmount,
			FORMAT((norderQuantity - IF(porderQuantity,porderQuantity,0)) / norderQuantity * 100,2) AS orderQuantity,
			FORMAT((noperatingCosts - IF(poperatingCosts,poperatingCosts,0)) / noperatingCosts * 100,2) AS operatingCosts,
			FORMAT((nmonthInvestment - IF(pmonthInvestment,pmonthInvestment,0)) / nmonthInvestment * 100,2) AS monthInvestment
		FROM
			(
				SELECT
					SUM(total_income) AS ntotalIncome,
					SUM(total_profit) AS ntotalProfit,
					SUM(total_tax) AS ntotalTax,
					SUM(emp_quantity) AS nempQuantity,
					SUM(employee_compensation) AS nemployeeCompensation,
					SUM(loan_amount) AS nloanAmount,
					SUM(order_quantity) AS norderQuantity,
					SUM(operating_costs) AS noperatingCosts,
					SUM(month_investment) AS nmonthInvestment,
					MONTH AS "month", YEAR AS "year"
					<choose>  
			            <!-- <when test="statisticsType == 'MONTH'">MONTH AS "month", YEAR AS "year"</when>   -->
			            <when test="statisticsType == 'areaName'">, area_name AS "areaName"</when>  
		             	<when test="statisticsType == 'typeName'">, type_name AS "typeName"</when>
	          		</choose>
				FROM
					statis_view
				WHERE
					`year` = #{year}
					AND `month`   &lt;= #{month}
				<if test="typeName != null and typeName != ''">
					AND type_name = #{typeName}
				</if>
				<if test="areaName != null and areaName != ''">
					AND area_name = #{areaName}
				</if>
				<if test="companyName != null and companyName != ''">
					AND company_Name like CONCAT(CONCAT('%', #{companyName}), '%')
				</if>
					AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
				GROUP BY 
					<choose>  
			             <when test="statisticsType == 'MONTH'">MONTH</when>  
			             <when test="statisticsType == 'areaName'">area_name</when>
			             <when test="statisticsType == 'typeName'">type_name</when> 
	          		</choose>
			) n 
		RIGHT JOIN (
			SELECT 
				pt.ptotalIncome,
				pt.ptotalProfit,
				pt.ptotalTax,
				pt.pempQuantity,
				pt.pemployeeCompensation,
				pt.ploanAmount,
				pt.porderQuantity,
				pt.poperatingCosts,
				pt.pmonthInvestment,
				c1.*
				<if test="queryType == 2">
					,pt.month as month1,
					pt.year
				</if>
			FROM (
			
				SELECT
					SUM(total_income) AS ptotalIncome,
					SUM(total_profit) AS ptotalProfit,
					SUM(total_tax) AS ptotalTax,
					SUM(emp_quantity) AS pempQuantity,
					SUM(employee_compensation) AS pemployeeCompensation,
					SUM(loan_amount) AS ploanAmount,
					SUM(order_quantity) AS porderQuantity,
					SUM(operating_costs) AS poperatingCosts,
					SUM(month_investment) AS pmonthInvestment,
					MONTH AS "month", YEAR AS "year"
					<choose>  
			             <!-- <when test="statisticsType == 'MONTH'">MONTH AS "month", YEAR AS "year"</when>   -->
			             <when test="statisticsType == 'areaName'">, area_name AS "areaName"</when>  
			             <when test="statisticsType == 'typeName'">, type_name AS "typeName"</when>
		          	</choose>
				FROM
					statis_view
				WHERE
					<choose>  
		             	<when test="queryType == 1">`year` = #{preYear} AND `month`   &lt;= #{month}</when>  
		             	<when test="queryType == 2">( `year` = #{year} AND `month` &lt; #{month} ) OR ( `year` = (#{year} - 1) AND `month` = '12')</when>
		          	</choose>
					
					<if test="typeName != null and typeName != ''">
						AND type_name = #{typeName}
					</if>
					<if test="areaName != null and areaName != ''">
						AND area_name = #{areaName}
					</if>
					<if test="companyName != null and companyName != ''">
						AND company_Name like CONCAT(CONCAT('%', #{companyName}), '%')
					</if>
					AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
				GROUP BY 
					<choose>  
			             <when test="statisticsType == 'MONTH'">MONTH</when>  
			             <when test="statisticsType == 'areaName'">area_name</when>
			             <when test="statisticsType == 'typeName'">type_name</when>  
		          	</choose>
			) pt
			 RIGHT JOIN (
				<choose>
	          		<when test="statisticsType == 'MONTH'">
						SELECT
							MONTH AS month
						FROM
							statis_view
						WHERE
							`year` = #{year}
							AND `month`   &lt;= #{month}
						GROUP BY MONTH
					</when>  
		            <when test="statisticsType == 'areaName'">
						SELECT
							name AS areaName
						FROM
							sys_area
						WHERE
							type != 1 AND type !=2
					</when> 
		            <when test="statisticsType == 'typeName'">
						SELECT
							label AS typeName
						FROM 
							sys_dict 
						WHERE 
							type=#{dictType}
					</when>
		        </choose>
				) c1 ON <choose>  
				             <when test="statisticsType == 'MONTH'">c1.`month` = pt.`month`</when>  
				             <when test="statisticsType == 'areaName'">c1.`areaName` = pt.`areaName`</when> 
				             <when test="statisticsType == 'typeName'">c1.`typeName` = pt.`typeName`</when> 
			          	</choose>
				
			)p	ON 
				<choose>  
		             <when test="statisticsType == 'MONTH' and queryType == 1">n.`month` = p.`month`</when> 
		             <when test="queryType == 2">IF ( (n.`month` - 1) = 0, n.year - 1 = p.year AND (n.`month` + 11) = p.`month1` , n.year = p.year AND (n.`month` - 1) = p.`month1` )</when> 
		             <when test="statisticsType == 'areaName'">n.`areaName` = p.`areaName`</when>
		             <when test="statisticsType == 'typeName'">n.`typeName` = p.`typeName`</when>  
	          	</choose>
	          	<choose>  
		             <when test="statisticsType == 'areaName' and queryType == 2">AND n.`areaName` = p.`areaName`</when>
		             <when test="statisticsType == 'typeName' and queryType == 2">AND n.`typeName` = p.`typeName`</when>  
	          	</choose>
	   
		
	</select>
	
	<select id="getAmountQytb" parameterType="com.hailian.whly.reportstatistics.entity.ReportStatistics" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
			SELECT
				totalIncome,
				totalProfit,
				totalTax,
				empQuantity,
				employeeCompensation,
				loanAmount,
				orderQuantity,
				operatingCosts,
				month_investment,
				c.*
			FROM (SELECT
				SUM(total_income) AS totalIncome,
				SUM(total_profit) AS totalProfit,
				SUM(total_tax) AS totalTax,
				SUM(emp_quantity) AS empQuantity,
				SUM(employee_compensation) AS employeeCompensation,
				SUM(loan_amount) AS loanAmount,
				SUM(order_quantity) AS orderQuantity,
				SUM(operating_costs) AS operatingCosts,
				SUM(month_investment) AS month_investment,
				<choose>  
		            <when test="statisticsType == 'MONTH'">MONTH AS month</when>
		            <when test="statisticsType == 'areaName'">area_name AS areaName</when>  
	             	<when test="statisticsType == 'typeName'">type_name AS typeName</when>
          		</choose>
				FROM
					statis_view
				WHERE
					`year` = #{year}
					AND `month`   &lt;= #{month}
				<if test="typeName != null and typeName != ''">
					AND type_name = #{typeName}
				</if>
				<if test="areaName != null and areaName != ''">
					AND area_name = #{areaName}
				</if>
				<if test="companyName != null and companyName != ''">
					AND company_Name like CONCAT(CONCAT('%', #{companyName}), '%')
				</if>
					AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
				GROUP BY 
					<choose>  
			             <when test="statisticsType == 'MONTH'">MONTH</when>  
			             <when test="statisticsType == 'areaName'">area_name</when>
			             <when test="statisticsType == 'typeName'">type_name</when> 
	          		</choose>
          	) n RIGHT JOIN (
          		<choose>
	          		<when test="statisticsType == 'MONTH'">
						SELECT
							MONTH AS name
						FROM
							statis_view
						WHERE
							`year` = #{year}
							AND `month`   &lt;= #{month}
							AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
						GROUP BY MONTH
					</when>  
		            <when test="statisticsType == 'areaName'">
						SELECT
							name
						FROM
							sys_area
						WHERE
							type != 1 AND type != 2
					</when> 
		            <when test="statisticsType == 'typeName'">
						SELECT
							label AS name
						FROM 
							sys_dict 
						WHERE 
							type=#{dictType}
					</when>
	            </choose>
			) c ON 
					<choose>  
			             <when test="statisticsType == 'MONTH'">c.`name` = n.`month`</when>  
			             <when test="statisticsType == 'areaName'">c.`name` = n.`areaName`</when> 
			             <when test="statisticsType == 'typeName'">c.`name` = n.`typeName`</when> 
		          	</choose>
    </select>
    
    <select id="getProportionQytb" parameterType="com.hailian.whly.reportstatistics.entity.ReportStatistics" resultType="com.hailian.whly.reportstatistics.entity.ReportStatistics">
			SELECT
				p.totalIncome,
				p.totalProfit,
				p.totalTax,
				p.empQuantity,
				p.employeeCompensation,
				p.loanAmount,
				p.orderQuantity,
				p.operatingCosts,
				p.monthInvestment,
				c.*
			FROM (SELECT
				FORMAT(n.totalIncome/ s.totalIncome *100, 2) AS totalIncome ,
				FORMAT(n.totalProfit / s.totalProfit *100, 2) AS totalProfit ,
				FORMAT(n.totalTax / s.totalTax *100, 2) AS totalTax ,
				FORMAT( n.empQuantity / s.empQuantity *100, 2) AS empQuantity ,
				FORMAT(n.employeeCompensation/ s.employeeCompensation *100, 2) AS employeeCompensation ,
				FORMAT(n.loanAmount / s.loanAmount *100, 2) AS loanAmount ,
				FORMAT(n.orderQuantity / s.orderQuantity *100, 2) AS orderQuantity ,
				FORMAT(n.operatingCosts/ s.operatingCosts *100, 2) AS operatingCosts ,
				FORMAT(n.monthInvestment / s.monthInvestment *100, 2) AS monthInvestment ,
				<choose>  
		            <when test="statisticsType == 'MONTH'">n.month as name</when>
		            <when test="statisticsType == 'areaName'">n.areaName as name</when>  
	             	<when test="statisticsType == 'typeName'">n.typeName as name</when>
          		</choose>
			FROM (SELECT
				SUM(total_income) AS totalIncome,
				SUM(total_profit) AS totalProfit,
				SUM(total_tax) AS totalTax,
				SUM(emp_quantity) AS empQuantity,
				SUM(employee_compensation) AS employeeCompensation,
				SUM(loan_amount) AS loanAmount,
				SUM(order_quantity) AS orderQuantity,
				SUM(operating_costs) AS operatingCosts,
				SUM(month_investment) AS monthInvestment,
				<choose>  
		            <when test="statisticsType == 'MONTH'">MONTH AS month</when>
		            <when test="statisticsType == 'areaName'">area_name AS areaName</when>  
	             	<when test="statisticsType == 'typeName'">type_name AS typeName</when>
          		</choose>
				FROM
					statis_view
				WHERE
					`year` = #{year}
					AND `month`   &lt;= #{month}
				<if test="typeName != null and typeName != ''">
					AND type_name = #{typeName}
				</if>
				<if test="areaName != null and areaName != ''">
					AND area_name = #{areaName}
				</if>
				<if test="companyName != null and companyName != ''">
					AND company_Name like CONCAT(CONCAT('%', #{companyName}), '%')
				</if>
					AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
				GROUP BY 
					<choose>  
			             <when test="statisticsType == 'MONTH'">MONTH</when>  
			             <when test="statisticsType == 'areaName'">area_name</when>
			             <when test="statisticsType == 'typeName'">type_name</when> 
	          		</choose>
          	) n , (
          		SELECT
				SUM(total_income) AS totalIncome,
				SUM(total_profit) AS totalProfit,
				SUM(total_tax) AS totalTax,
				SUM(emp_quantity) AS empQuantity,
				SUM(employee_compensation) AS employeeCompensation,
				SUM(loan_amount) AS loanAmount,
				SUM(order_quantity) AS orderQuantity,
				SUM(operating_costs) AS operatingCosts,
				SUM(month_investment) AS monthInvestment
				FROM
					statis_view
				WHERE
					`year` = #{year}
					AND `month`   &lt;= #{month}
				<if test="typeName != null and typeName != ''">
					AND type_name = #{typeName}
				</if>
				<if test="areaName != null and areaName != ''">
					AND area_name = #{areaName}
				</if>
				<if test="companyName != null and companyName != ''">
					AND company_Name like CONCAT(CONCAT('%', #{companyName}), '%')
				</if>
					AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
			) s ) p  RIGHT JOIN (
          		<choose>
	          		<when test="statisticsType == 'MONTH'">
						SELECT
							MONTH AS name
						FROM
							statis_view
						WHERE
							`year` = #{year}
							AND `month`   &lt;= #{month}
							AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
						GROUP BY MONTH
					</when>  
		            <when test="statisticsType == 'areaName'">
						SELECT
							name
						FROM
							sys_area
						WHERE
							type != 1 AND type != 2
					</when> 
		            <when test="statisticsType == 'typeName'">
						SELECT
							label AS name
						FROM 
							sys_dict 
						WHERE 
							type=#{dictType}
					</when>
	            </choose>
			) c ON 
					<choose>  
			             <when test="statisticsType == 'MONTH'">c.`name` = p.`name`</when>  
			             <when test="statisticsType == 'areaName'">c.`name` = p.`name`</when> 
			             <when test="statisticsType == 'typeName'">c.`name` = p.`name`</when> 
		          	</choose>
			
    </select>
	
	<!--陈新 地区从业人数分析  -->
	<select id="getAreaEnploymentNumberAnalysis" parameterType="com.hailian.whly.reportstatistics.entity.ReportStatistics" resultMap="areaEnploymentNumberAnalysis">
		
		 
	 select v2.area_name,ifnull(emp_quantity,0) emp_quantity from
		(select area_name,sum(emp_quantity) emp_quantity from statis_view 
			<where>
			<if test="year!=null and year!=''">year=#{year}</if>
			<if test="month!=null and month!=''">and month=#{month}</if>
			<if test="typeName!=null and typeName!=''">and type_name=#{typeName}</if>
			<if test="companyName != null and companyName != ''">and company_Name like CONCAT(CONCAT('%', #{companyName}), '%')</if>
			AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
		</where>
			group by area_name
		) v1 right join 
		(select area_name from statis_view  group by area_name  )v2
	on v1.area_name = v2.area_name
	
	</select>
	<!--陈新 行业从业人数分析  -->
	<select id="getIndustryEnploymentNumberAnalysis" parameterType="com.hailian.whly.reportstatistics.entity.ReportStatistics" resultMap="industryEnploymentNumberAnalysis">

	select v2.type_name,ifnull(emp_quantity,0)emp_quantity from
		(select type_name,sum(emp_quantity) emp_quantity from statis_view 
			<where>
			<if test="year!=null and year!=''">year=#{year}</if>
			<if test="month!=null and month!=''">and month=#{month}</if>
			<if test="areaName!=null and areaName!=''">and area_name=#{areaName}</if>
			<if test="companyName != null and companyName != ''">and company_Name like CONCAT(CONCAT('%', #{companyName}), '%')</if>
			AND company_id in(select id from sys_office where parent_ids like CONCAT(CONCAT('%', #{parentId}), '%'))
		</where> 
			group by type_name
		) v1 right join 
		(select distinct label type_name from sys_dict where type=#{dictType})v2
	on v1.type_name = v2.type_name
	
	</select>
</mapper>